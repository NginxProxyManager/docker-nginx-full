#!/bin/bash -e

echo -e "${BLUE}❯ ${CYAN}Building ModSecurity from branch ${YELLOW}${MODSECURITY_BRANCH}...${RESET}"

# modsecurity connector
mkdir /tmp/modsecurity-nginx
curl -# -L "${MODSECURITY_NGINX_URL}" | tar -xz --strip 1 -C /tmp/modsecurity-nginx
# modsecurity
git clone --branch "${MODSECURITY_BRANCH}" "${MODSECURITY_GIT_URL}" /tmp/modsecurity
cd /tmp/modsecurity
if [ -n "${MODSECURITY_COMMIT_SHA}" ]; then
  git checkout "$MODSECURITY_COMMIT_SHA"
fi
git submodule init
git submodule update
./build.sh
#     --with-lmdb \
#--enable-parser-generation \
#  --enable-mutex-on-pm
./configure
make -j20
make install
mkdir /tmp/configs
cp /tmp/modsecurity/modsecurity.conf-recommended /tmp/configs/modsecurity.conf
cp /tmp/modsecurity/unicode.mapping /tmp/configs/unicode.mapping
echo -e "${BLUE}❯ ${GREEN}ModSecurity build completed${RESET}"
